let deck,trumpCard,trumpSuit,discardPile=[],players=[],dealerIndex=0,pot=0,currentAnte=5,roundsCompleted=0,initialActivePlayers=0,firstDealerOfRound=null,currentRoundDealer=null,gameMode="normal",waitingForPlayerInput=!1,playerInputResolver=null,currentInputType=null,selectedCardsForDiscard=[],selectedCardForPlay=null,validCardsForPlay=[];async function startGame(e,a="normal"){for(gameMode=a,buildDeck(),updateAnteUI(currentAnte),shuffleDeck(),createPlayers(e),assignDealer(),firstDealerOfRound=players[dealerIndex],currentRoundDealer=players[dealerIndex],initialActivePlayers=getActivePlayers().length;getActivePlayers().length>1;){resetPlayersForNewRound();const e=getActivePlayers();if(1===e.length)return endGameSequence(e[0]);displayActivePlayers(e),createPot(),dealCardsToPlayers(),dealTrump(),await makePlayDecisions();if(0===getPlayingPlayers().length){if(await showAllFoldedResults(),!advanceRound())return;continue}if(await handleSinglePlayerPlaying()){if(!advanceRound())return;continue}if(await handleDiscards(),getPlayingPlayers().length<2){if(await handleSinglePlayerPlaying()||!advanceRound())return;continue}const a=await playTricks();if(handleAnteExemptions(determineWinner(a),a),await handlePayments(a),eliminateAllInPlayersAtEndOfRound(),!advanceRound())return}const r=getActivePlayers()[0];r&&endGameSequence(r)}function advanceRound(){const e=getActivePlayers();return 1===e.length?(endGameSequence(e[0]),!1):(players.forEach((e=>{e.active&&(e.allIn=!1)})),nextDealer(),buildDeck(),shuffleDeck(),discardPile=[],!0)}function displayActivePlayers(e){}function buildDeck(){const e=["2","3","4","5","6","7","8","9","10","J","Q","K","A"];deck=[],["C","D","H","S"].forEach((a=>e.forEach((e=>deck.push(`${e}-${a}`)))))}function shuffleDeck(){for(let e=0;e<deck.length;e++){const a=Math.floor(Math.random()*deck.length);[deck[e],deck[a]]=[deck[a],deck[e]]}}function reshuffleDiscards(){if(0===discardPile.length)return;const e=[...new Set(discardPile)];deck.push(...e),discardPile=[],shuffleDeck()}function createPlayers(e){const a=["Mary","James","Barbara","John","Emma","Michael","Robert"];players=[{name:e,cards:[],fiches:500,active:!0,passed:!1,allIn:!1,anteExempt:!1,cardsToDraw:0,propic:"Player.jpeg"}];for(let e=0;e<7;e++)players.push({name:a[e],cards:[],fiches:500,active:!0,passed:!1,allIn:!1,anteExempt:!1,cardsToDraw:0,propic:`${a[e]}.jpeg`})}function resetPlayersForNewRound(){players.forEach((e=>{e.fiches>0?e.active=!0:e.fiches<=0&&!e.anteExempt&&(e.active=!1),e.passed=!1,e.allIn=!1,e.cardsToDraw=0}))}function updatePlayerStatus(){players.forEach((e=>{e.fiches<=0&&e.active&&!e.allIn&&!e.anteExempt&&(e.active=!1)}))}function eliminateAllInPlayersAtEndOfRound(){players.forEach((e=>{e.active&&e.fiches<=0&&(e.allIn?e.active=!1:e.anteExempt||(e.active=!1))}))}function getActivePlayers(){return updatePlayerStatus(),players.filter((e=>e.active))}function getPlayingPlayers(){return getActivePlayers().filter((e=>!e.passed))}function assignDealer(){const e=getActivePlayers(),a=Math.floor(Math.random()*e.length);dealerIndex=players.indexOf(e[a])}function handleAnteExemptions(e,a){players.forEach((e=>e.anteExempt=!1)),e.boorayPlayers?.length>0&&e.boorayPlayers.forEach((e=>{const a=players.find((a=>a.name===e));a&&(a.anteExempt=!0)})),e.isSplit&&e.tiedPlayers&&e.tiedPlayers.forEach((e=>{const a=players.find((a=>a.name===e));a&&(a.anteExempt=!0)}))}async function handleSinglePlayerPlaying(){const e=getPlayingPlayers();if(1===e.length){const a=e[0];return a.fiches+=pot,pot=0,updatePotUI(pot),await showSinglePlayerWinResults(a.name),eliminateAllInPlayersAtEndOfRound(),players.forEach((e=>{e.active&&(e.allIn=!1)})),!0}return!1}async function showAllFoldedResults(){const e=players[0].name,a={results:{}};getActivePlayers().forEach((e=>{a.results[e.name]="Folded"})),updateOpponentsUI(players,e,[],null,dealerIndex,a),await new Promise((e=>setTimeout(e,5e3)))}async function showSinglePlayerWinResults(e){const a=players[0].name,r={results:{}};getActivePlayers().forEach((a=>{a.name===e?r.results[a.name]="Winner":a.passed&&(r.results[a.name]="Folded")})),updateOpponentsUI(players,a,[],null,dealerIndex,r),await new Promise((e=>setTimeout(e,5e3)))}function createPot(){const e=getActivePlayers();let a=0;updateAnteUI(currentAnte),e.forEach((e=>{if(e.anteExempt)e.fiches<=0&&(e.allIn=!0);else{const r=Math.min(currentAnte,e.fiches);e.fiches-=r,pot+=r,a+=r,e.fiches<=0?e.allIn=!0:e.allIn=!1}})),updatePotUI(pot)}function dealCardsToPlayers(){const e=getActivePlayers(),a=e.length<5?3:5;players.forEach((e=>e.cards=[]));const r=a*e.length+1;deck.length<r&&reshuffleDiscards();for(let r=0;r<a;r++)for(let a=0;a<e.length;a++){const r=e.findIndex((e=>e===players[dealerIndex])),t=e[(r+1+a)%e.length];deck.length>0&&t.cards.push(deck.pop())}const t=players[0];t&&(document.getElementById("player-hand-section").classList.remove("hidden"),updatePlayerHandUI(t.cards)),updateOpponentsUI(players,t.name,[],null,dealerIndex)}function dealTrump(){deck.length>0&&(trumpCard=deck.pop(),trumpSuit=trumpCard.split("-")[1],updateTrumpCardUI(trumpCard))}async function makePlayDecisions(){const e=getActivePlayers(),a=players[0].name;for(const r of e){if(r.name===a)if(r.allIn)r.passed=!1;else{const e=await waitForPlayerInput(`${r.name}, play this round?`,"play_decision");r.passed="y"!==e.toLowerCase(),r.passed&&document.getElementById("player-hand-section").classList.add("hidden")}else r.allIn?r.passed=!1:r.passed=!playOrFold(r);updateOpponentsUI(players,a,[],null,dealerIndex)}}function playOrFold(e){const a=calculatePlayDecisionWeight(e);return Math.floor(101*Math.random())<=a}function calculatePlayDecisionWeight(e){const a=getActivePlayers(),r=e.cards.length,t=countHighCards(e.cards),n=countTrumpCards(e.cards),l=getHighCardsWeight(t,r)+getTrumpCardsWeight(n,r)+getPotFichesWeight(pot,e.fiches)+getCardsPlayersWeight(r,a.length);return Math.max(0,Math.min(100,25+l))}function countHighCards(e){return e.filter((e=>["A","K","Q","J"].includes(e.split("-")[0]))).length}function countTrumpCards(e){return e.filter((e=>e.split("-")[1]===trumpSuit)).length}function getHighCardsWeight(e,a){const r=e/a*100;return 0===r?0:r<=35?10:r<=45?20:r<=70?40:50}function getTrumpCardsWeight(e,a){const r=e/a*100;return 0===r?-20:r<=35?25:r<=45?50:r<=70?100:1e3}function getPotFichesWeight(e,a){if(0===a)return 1e3;const r=e/a*100;return r>=100?-15:r>=80?-10:r>=50?-5:r>=30?0:r>=20?25:r>=15?50:r>=10?75:r>=5?90:100}function getCardsPlayersWeight(e,a){const r=e/a*100;return r<=73?-10:r<=85?0:r<=100?20:50}async function handleDiscards(){const e=getPlayingPlayers(),a=players[0].name;players.filter((e=>e.passed&&e.cards.length>0)).forEach((e=>{discardPile.push(...e.cards),e.cards=[]}));for(const r of e)r.name===a?await handlePlayerDiscardsImmediate(r):discardWeakCardsImmediate(r)}async function handlePlayerDiscardsImmediate(e){deck.length<=5&&discardPile.length>0&&reshuffleDiscards(),selectedCardsForDiscard=[],updatePlayerHandUIForDiscard(e.cards),showDiscardButton();if("skip"===await waitForPlayerInput("Select cards to discard and press Discard, or press Skip","discard")||0===selectedCardsForDiscard.length)return clearActionButtons(),void updatePlayerHandUI(e.cards);const a=[];selectedCardsForDiscard.sort(((e,a)=>a-e)).forEach((r=>{a.push(e.cards.splice(r,1)[0])}));const r=a.length,t=[];for(let e=0;e<r&&(0===deck.length&&discardPile.length>0&&reshuffleDiscards(),deck.length>0);e++){const e=deck.pop();t.push(e)}e.cards.push(...t),discardPile.push(...a),clearActionButtons(),updatePlayerHandUI(e.cards)}async function handlePlayerDiscardsImmediate(e){deck.length<=5&&discardPile.length>0&&reshuffleDiscards(),selectedCardsForDiscard=[],updatePlayerHandUIForDiscard(e.cards),showDiscardButton();if("skip"===await waitForPlayerInput("Select cards to discard and press Discard, or press Skip","discard")||0===selectedCardsForDiscard.length)return clearActionButtons(),void updatePlayerHandUI(e.cards);const a=[];selectedCardsForDiscard.sort(((e,a)=>a-e)).forEach((r=>{a.push(e.cards.splice(r,1)[0])}));const r=a.length,t=[];for(let e=0;e<r&&(0===deck.length&&discardPile.length>0&&reshuffleDiscards(),deck.length>0);e++){const e=deck.pop();t.push(e)}e.cards.push(...t),discardPile.push(...a),clearActionButtons(),updatePlayerHandUI(e.cards)}function discardWeakCardsImmediate(e){deck.length<=5&&discardPile.length>0&&reshuffleDiscards();const a=[],r=[];if(e.cards.forEach((e=>{const[t,n]=e.split("-");isCardWeak(t,n)?a.push(e):r.push(e)})),a.length>0){e.cards=r;const t=a.length;for(let a=0;a<t&&(0===deck.length&&discardPile.length>0&&reshuffleDiscards(),deck.length>0);a++)e.cards.push(deck.pop());discardPile.push(...a)}}function isCardWeak(e,a){return a!==trumpSuit&&getCardNumericValue(e)<=7}function getCardNumericValue(e){return{2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,J:11,Q:12,K:13,A:14}[e]||0}async function playTricks(){const e=getPlayingPlayers(),a={};e.forEach((e=>a[e.name]=0));let r=findNextPlayingPlayer(dealerIndex);const t=e.length>0?e[0].cards.length:0;for(let e=1;e<=t;e++){const{winningPlayer:e,trick:t}=await playTrick(r,a);a[e.name]++;const n=t.map((e=>({playerName:e.player.name,card:e.card})));await handleTrickAnimation(n,e.name,a),r=players.indexOf(e)}return a}async function playTrick(e,a){const r=getPlayingPlayers(),t=r.flatMap((e=>e.cards));t.filter(((e,a)=>t.indexOf(e)!==a)).length;const n=[];let l=null,s=null,i=null;const d=players[0].name;for(let t=0;t<r.length;t++){const c=(r.indexOf(players[e])+t)%r.length,o=r[c];if(0===o.cards.length)continue;const u=o.name===d?await chooseCardToPlayHuman(o,l,s,n):chooseCardToPlay(o,l,s,n);if(null===u)continue;const p={player:o,card:u};n.push(p);const y=o.cards.indexOf(u);y>-1&&o.cards.splice(y,1),0===t?(l=u.split("-")[1],s=u,i=o):isCardHigher(u,s,l)&&(s=u,i=o);const f=n.map((e=>({playerName:e.player.name,card:e.card}))),h={playerName:o.name,card:u};updateOpponentsUI(players,d,f,a,dealerIndex,null,h),await new Promise((e=>setTimeout(e,600)))}return{winningPlayer:i,trick:n}}async function chooseCardToPlayHuman(e,a,r,t){if(0===e.cards.length)return null;if(validCardsForPlay=getValidCards(e.cards,a,r,t),selectedCardForPlay=null,updatePlayerHandUIForPlay(e.cards,validCardsForPlay,!0),await waitForPlayerInput("Select a card to play","card_play"),null!==selectedCardForPlay&&selectedCardForPlay>=0&&selectedCardForPlay<e.cards.length){const a=e.cards[selectedCardForPlay];if(validCardsForPlay.includes(a)){const r=e.cards.filter((e=>e!==a));return updatePlayerHandUIForPlay(r,[],!1),a}}return updatePlayerHandUIForPlay(e.cards,[],!1),e.cards[0]}function chooseCardToPlay(e,a,r,t){if(0===e.cards.length)return null;const n=getValidCards(e.cards,a,r,t);return 0===n.length?e.cards[0]:1===n.length?n[0]:chooseCardStrategic(e,a,r,t,n)}function chooseCardStrategic(e,a,r,t,n){if(!a)return chooseLeadCard(n);const l=n.filter((e=>isCardHigher(e,r,a)));return l.length>0?getLowestWinningCard(l,r,a):getLowestCard(n)}function chooseLeadCard(e){const a=e.filter((e=>e.split("-")[1]===trumpSuit));if(a.length>0){if(1===a.length)return a[0];const e=sortCardsByValue(a);return e[Math.min(Math.floor(.6*e.length),e.length-1)]}const r=sortCardsByValue(e);return r.length>=3?r[Math.floor(.7*r.length)]:(r.length,r[0])}function getLowestWinningCard(e,a,r){return e.reduce(((e,t)=>isCardHigher(t,a,r)&&isCardHigher(e,a,r)&&compareCardStrength(t,e,r)<0?t:e))}function compareCardStrength(e,a,r){const[t,n]=e.split("-"),[l,s]=a.split("-"),i=getCardNumericValue(t),d=getCardNumericValue(l),c=n===trumpSuit,o=s===trumpSuit;return c&&!o?1:!c&&o||i<d?-1:i>d?1:0}function sortCardsByValue(e){return e.sort(((e,a)=>{const[r,t]=e.split("-"),[n,l]=a.split("-"),s=getCardNumericValue(r),i=getCardNumericValue(n),d=t===trumpSuit,c=l===trumpSuit;return d&&!c?1:!d&&c?-1:s-i}))}function getValidCards(e,a,r,t){if("no_rules"===gameMode)return e;if(!a)return e;const n=e.filter((e=>e.split("-")[1]===a));if(n.length>0)return n;const l=e.filter((e=>e.split("-")[1]===trumpSuit));return l.length>0?l:e}function isCardHigher(e,a,r){if(!e||!a)return!1;const[t,n]=e.split("-"),[l,s]=a.split("-");return n===trumpSuit&&s!==trumpSuit||(s!==trumpSuit||n===trumpSuit)&&(n===s?getCardNumericValue(t)>getCardNumericValue(l):n===r&&s!==r)}function getLowestCard(e){return 0===e.length?null:e.reduce(((e,a)=>{const[r]=e.split("-"),[t]=a.split("-");return getCardNumericValue(t)<getCardNumericValue(r)?a:e}))}function findNextPlayingPlayer(e){const a=getPlayingPlayers();for(let r=1;r<=players.length;r++){const t=(e+r)%players.length;if(a.includes(players[t]))return t}return e}function determineWinner(e){const a=Math.max(...Object.values(e)),r=Object.entries(e).filter((([e,r])=>r===a));return 1===r.length?{winner:r[0][0],isSplit:!1,boorayPlayers:getBoorayPlayers(e)}:{winner:null,isSplit:!0,tiedPlayers:r.map((e=>e[0])),boorayPlayers:getBoorayPlayers(e)}}function getBoorayPlayers(e){return Object.entries(e).filter((([e,a])=>{const r=players.find((a=>a.name===e));return 0===a&&r&&!r.passed})).map((([e])=>e))}async function handlePayments(e){const a=determineWinner(e),r=pot;if(await showRoundResults(a,e),a.boorayPlayers.length>0){const e=r;a.boorayPlayers.forEach((a=>{const r=players.find((e=>e.name===a)),t=Math.min(e,r.fiches);r.fiches-=t,pot+=t}))}if(!a.isSplit&&a.winner){players.find((e=>e.name===a.winner)).fiches+=r,pot-=r,pot<0&&(pot=0)}}function nextDealer(){const e=getActivePlayers(),a=players[dealerIndex],r=e.findIndex((e=>e===a)),t=e[(r+1)%e.length];dealerIndex=players.indexOf(t),firstDealerOfRound&&!firstDealerOfRound.active&&(firstDealerOfRound=t),t===firstDealerOfRound&&(roundsCompleted++,currentAnte*=2,updateAnteUI(currentAnte))}function waitForPlayerInput(e,a){return new Promise((e=>{waitingForPlayerInput=!0,playerInputResolver=e,currentInputType=a,"play_decision"===a&&showPlayDecisionButtons()}))}function resetGame(){deck=[],discardPile=[],players=[],dealerIndex=0,trumpCard=null,trumpSuit=null,pot=0,currentAnte=5,roundsCompleted=0,initialActivePlayers=0,firstDealerOfRound=null,currentRoundDealer=null,gameMode="normal",waitingForPlayerInput=!1,playerInputResolver=null,currentInputType=null,selectedCardsForDiscard=[],selectedCardForPlay=null,validCardsForPlay=[],updatePotUI(0),updateAnteUI(5),updateTrumpCardUI("");const e=document.getElementById("player-hand-section");e&&(e.innerHTML="");const a=document.getElementById("players-section-container");a&&(a.innerHTML=""),showPreGameUI()}function endGameSequence(e){pot>0&&(e.fiches+=pot,pot=0,updatePotUI(pot)),showGameEndUI(e.name);const a=players.length>0?players[0].name:"Player1";updateOpponentsUI(players,a,[],null,dealerIndex)}window.playerInput=function(e){if(!waitingForPlayerInput||!playerInputResolver)return;waitingForPlayerInput=!1;const a=playerInputResolver;playerInputResolver=null,a(e)},window.selectCardForDiscard=function(e){const a=selectedCardsForDiscard.indexOf(e);a>-1?selectedCardsForDiscard.splice(a,1):selectedCardsForDiscard.push(e);const r=players.find((e=>e.name===players[0].name));r&&updatePlayerHandUIForDiscard(r.cards)},window.selectCardForPlay=function(e){const a=players.find((e=>e.name===players[0].name));a&&a.cards[e]&&validCardsForPlay.includes(a.cards[e])&&(selectedCardForPlay=e,updatePlayerHandUIForPlay(a.cards,validCardsForPlay))},window.processDiscard=function(){if(waitingForPlayerInput&&"discard"===currentInputType&&playerInputResolver){waitingForPlayerInput=!1;const e=playerInputResolver;playerInputResolver=null,e("discard_selected")}},window.skipDiscard=function(){if(waitingForPlayerInput&&"discard"===currentInputType&&playerInputResolver){selectedCardsForDiscard=[],waitingForPlayerInput=!1;const e=playerInputResolver;playerInputResolver=null,e("skip")}},window.playSelectedCard=function(){if(waitingForPlayerInput&&"card_play"===currentInputType&&playerInputResolver&&null!==selectedCardForPlay){waitingForPlayerInput=!1;const e=playerInputResolver;playerInputResolver=null,e("card_selected")}};