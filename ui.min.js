const DOM={playerHand:document.getElementById("player-hand-section"),actionButtons:document.getElementById("action-buttons"),trumpCard:document.getElementById("trump-card-img"),pot:document.getElementById("pot-amount"),ante:document.getElementById("ante-amount"),players:document.getElementById("players-section-container"),preGame:document.getElementById("pre-game-container"),infoCard:document.querySelector(".info-card"),gameMode:document.getElementById("game-mode-switch"),playersContainer:document.getElementById("players-section-container")},uiState={updateQueue:[],isProcessing:!1},createEl=(e,t="",n={})=>{const a=document.createElement(e);return t&&(a.className=t),Object.entries(n).forEach((([e,t])=>a[e]=t)),a},clearElement=e=>{e&&(e.innerHTML="")},showGameUI=()=>{DOM.preGame?.classList.add("hidden"),DOM.infoCard?.classList.remove("hidden"),DOM.playersContainer?.classList.remove("hidden")},showPreGameUI=()=>{DOM.preGame?.classList.remove("hidden"),DOM.infoCard?.classList.add("hidden"),DOM.playersContainer?.classList.add("hidden"),DOM.gameMode&&(DOM.gameMode.checked=!1)};"ontouchstart"in window&&(document.addEventListener("touchstart",(function(){}),{passive:!0}),document.addEventListener("touchend",(()=>{document.querySelectorAll(".hand, .selectable-card").forEach((e=>{e.style.transform=""}))}),{passive:!0}));const createCardImg=(e,t="hand",n=null)=>{const a=createEl("img",t,{src:`cards/${e}.svg`,alt:e});return n&&(a.onclick=n),a},renderPlayerHand=(e,t={})=>{if(clearElement(DOM.playerHand),0===e.length)return;const n=createEl("div","container text-center"),a=createEl("div","row"),r=createEl("div","col");e.forEach(((e,n)=>{const a=createCardImg(e,t.baseClass||"hand",t.onClick?.(e,n));t.highlight?.(e,n)&&a.classList.add(t.highlightClass),r.appendChild(a)})),a.appendChild(r),n.appendChild(a),DOM.playerHand.appendChild(n)},updatePlayerHandUI=e=>{renderPlayerHand(e)},updatePlayerHandUIForDiscard=e=>{renderPlayerHand(e,{baseClass:"hand selectable-card",highlight:(e,t)=>selectedCardsForDiscard?.includes(t),highlightClass:"selected-for-discard",onClick:(e,t)=>()=>selectCardForDiscard(t)})},updatePlayerHandUIForPlay=(e,t,n=!1)=>{if(renderPlayerHand(e,{baseClass:"hand",highlight:e=>n&&t.includes(e),highlightClass:"selectable-card",onClick:(e,a)=>n&&t.includes(e)?()=>{if(selectedCardForPlay=a,waitingForPlayerInput&&"card_play"===currentInputType&&playerInputResolver){waitingForPlayerInput=!1;const e=playerInputResolver;playerInputResolver=null,e("card_selected")}}:null}),n){const n=DOM.playerHand.querySelectorAll("img");e.forEach(((e,a)=>{t.includes(e)||n[a]?.classList.add("non-playable-card")}))}},updateTrumpCardUI=e=>{DOM.trumpCard&&(e?(DOM.trumpCard.style.display="",DOM.trumpCard.src=`cards/${e}.svg`):(DOM.trumpCard.style.display="",DOM.trumpCard.src="cards/BACK.svg"))},updatePotUI=e=>{DOM.pot&&(DOM.pot.textContent=`${e}$`)},updateAnteUI=e=>{DOM.ante&&(DOM.ante.textContent=`${e}$`)},createButton=({text:e,class:t,onClick:n})=>createEl("button",`btn ${t}`,{textContent:e,onclick:n}),showDynamicButtons=e=>{if(clearElement(DOM.actionButtons),DOM.actionButtons.closest(".info-row").classList.remove("hidden"),1===e.length){const t=createButton(e[0]);t.classList.add("btn-lg"),DOM.actionButtons.appendChild(t)}else 2===e.length?e.forEach((e=>{const t=createButton(e);DOM.actionButtons.appendChild(t)})):e.forEach((e=>{const t=createButton(e);DOM.actionButtons.appendChild(t)}))},showPlayDecisionButtons=()=>{showDynamicButtons([{text:"PLAY",class:"btn-success btn-lg",onClick:()=>{window.playerInput("y")}},{text:"FOLD",class:"btn-danger btn-lg",onClick:()=>{window.playerInput("n"),showSkipButton()}}])},showDiscardButton=()=>{showDynamicButtons([{text:"DISCARD",class:"btn-primary btn-lg",onClick:()=>{processDiscard()}}])},showSkipButton=()=>{showDynamicButtons([{text:"SKIP",class:"btn-primary btn-lg",onClick:()=>{window.enableSkipMode()}}])},clearActionButtons=()=>{DOM.actionButtons&&(DOM.actionButtons.innerHTML="",DOM.actionButtons.closest(".info-row")?.classList.add("hidden"))},createPlayerCard=(e,t,n)=>{const{trickCards:a,tricksWon:r,dealerIndex:s,roundResult:l,animateCard:o}=n,i=createEl("div","col-auto text-center mx-2"),d=createEl("div","card-container d-flex align-items-center justify-content-center");d.style.height="100px";const c=a.find((t=>t.playerName===e.name));if(c){const t=createCardImg(c.card,"playerCard played-card");t.dataset.playerName=e.name,o?.playerName===e.name&&o?.card===c.card&&t.classList.add("card-moving-to-play"),d.appendChild(t)}else d.style.minHeight="100px";const u=createEl("img","propic",{src:`img/${e.propic}`});t===s&&u.classList.add("dealer-border");const p=createEl("div","player-info");p.innerHTML=`<strong>${e.name}</strong>`;const m=createEl("div","player-info");m.innerHTML=`<strong>${e.fiches}$</strong>`;const y=createEl("div","player-info");if(l?.results?.[e.name]){const t=l.results[e.name];y.textContent=t,y.className="player-info round-result";const n={Winner:"winner-result",Draw:"draw-result",Booray:"booray-result",Loser:"loser-result",Folded:"folded-result"};n[t]&&y.classList.add(n[t])}else if(e.active)if(e.passed)y.textContent="Folded",y.className="player-info round-result folded-result";else if(void 0!==r?.[e.name]){const t=players.filter((e=>e.active)).length>=5?5:3;y.textContent=`${r[e.name]}/${t}`,y.className="player-info round-result tricks-won-result"}else y.textContent="Playing",y.className="player-info round-result playing-result";else i.style.opacity="0.5",y.textContent="Eliminated",y.className="player-info round-result eliminated-result";return i.append(u,p,m,y,d),i},_renderOpponentsUI=(e,t,n=[],a=null,r=0,s=null,l=null)=>{clearElement(DOM.players);const o=createEl("div","container-fluid text-center"),i=createEl("div","row justify-content-center align-items-start"),d={trickCards:n,tricksWon:a,dealerIndex:r,roundResult:s,animateCard:l};e.forEach(((e,t)=>{const n=createPlayerCard(e,t,d);if(i.appendChild(n),3===t){const e=createEl("div","w-100 player-row-break");i.appendChild(e)}})),o.appendChild(i),DOM.players.appendChild(o)},updateOpponentsUI=(e,t,n=[],a=null,r=0,s=null,l=null)=>{uiState.updateQueue.push({players:e,localPlayerName:t,trickCards:n,tricksWon:a,dealerIndex:r,roundResult:s,animateCard:l}),uiState.isProcessing||processUiQueue()},processUiQueue=async()=>{for(uiState.isProcessing=!0;uiState.updateQueue.length>0;){const e=uiState.updateQueue.shift();_renderOpponentsUI(e.players,e.localPlayerName,e.trickCards,e.tricksWon,e.dealerIndex,e.roundResult,e.animateCard),e.animateCard&&"undefined"!=typeof skipAnimations&&!skipAnimations&&await new Promise((e=>setTimeout(e,500)))}uiState.isProcessing=!1},animateCardToPlay=(e,t)=>new Promise((n=>{const a=document.querySelectorAll(".playerCard"),r=Array.from(a).find((n=>n.dataset.playerName===e&&n.src.includes(t)));r?(r.classList.add("card-moving-to-play"),setTimeout((()=>{r.classList.remove("card-moving-to-play"),n()}),500)):n()})),animateCardsToWinner=(e,t)=>new Promise((t=>{"undefined"!=typeof skipAnimations&&skipAnimations?t():setTimeout((()=>{const n=document.querySelectorAll(".playerCard.played-card"),a=document.querySelectorAll(".col-auto");let r=null;if(a.forEach((t=>{t.querySelector(".player-info")?.textContent===e&&(r=t)})),!r||0===n.length)return void t();const s=r.getBoundingClientRect();let l=0;n.forEach((e=>{const a=e.getBoundingClientRect(),r=s.left-a.left,o=s.top-a.top;e.style.setProperty("--winner-x",`${r}px`),e.style.setProperty("--winner-y",`${o}px`),e.classList.add("card-moving-to-winner"),setTimeout((()=>{l++,l===n.length&&t()}),1e3)}))}),100)})),handleTrickAnimation=async(e,t,n)=>{for(;uiState.isProcessing;)await new Promise((e=>setTimeout(e,50)));await animateCardsToWinner(t);const a=players[0].name;updateOpponentsUI(players,a,[],n||{},dealerIndex)},waitForResultsDisplay=async()=>{await new Promise((e=>setTimeout(e,5e3)))},createRoundResultsForUI=(e,t,n)=>{const a={};return Object.keys(t).forEach((t=>{const n=players.find((e=>e.name===t));n&&n.passed||(e.isSplit&&e.tiedPlayers?.includes(t)?a[t]="Draw":e.winner===t?a[t]="Winner":e.boorayPlayers?.includes(t)?a[t]="Booray":a[t]="Loser")})),{results:a}},showRoundResults=async(e,t)=>{const n=players[0].name,a=(getPlayingPlayers(),createRoundResultsForUI(e,t));updateOpponentsUI(players,n,[],t,dealerIndex,a),await waitForResultsDisplay()},showGameEndUI=e=>{clearElement(DOM.actionButtons);const t=createEl("div","alert alert-success text-center mb-2",{textContent:`${e} WINS!`});Object.assign(t.style,{fontWeight:"bold",fontSize:"1.2rem",margin:"10px 0"}),DOM.actionButtons.appendChild(t),showDynamicButtons([{text:"NEW GAME",class:"btn-primary",onClick:()=>resetGame()}])};let gameStarted=!1;function initializeGame(){let e=document.getElementById("player-name-input").value.trim();e||(e="Player");const t=document.getElementById("game-mode-switch").checked?"no_rules":"normal";document.getElementById("back-button").classList.remove("hidden"),gameStarted=!0,DOM.preGame?.classList.add("hidden"),DOM.infoCard?.classList.remove("hidden"),DOM.playersContainer?.classList.remove("hidden"),startGame(e,t).catch(console.error)}function confirmNewGame(){location.reload()}window.addEventListener("beforeunload",(e=>{gameStarted&&(e.preventDefault(),e.returnValue="")}));